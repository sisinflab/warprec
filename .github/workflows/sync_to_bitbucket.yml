name: Sync Merged PR to Bitbucket

# on:
#   pull_request:
#     branches: [main]
#     types: [closed]
on:
  pull_request:
    branches: ["*"]
  push:
    branches: [main]

jobs:
  sync:
    # if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set SOURCE_BRANCH output
        id: vars
        # run: echo "SOURCE_BRANCH=${{ github.event.pull_request.head_ref }}" >> $GITHUB_OUTPUT
        run: echo "SOURCE_BRANCH=test-branch" >> $GITHUB_OUTPUT

      - name: Push to Bitbucket target branch
        env:
          BITBUCKET_USERNAME: ${{ secrets.BITBUCKET_USERNAME }}
          BITBUCKET_PASSWORD: ${{ secrets.BITBUCKET_PASSWORD }}
          BITBUCKET_WORKSPACE: ${{ secrets.BITBUCKET_WORKSPACE }}
          BITBUCKET_REPO: ${{ secrets.BITBUCKET_REPO }}
        run: |
          git remote add bitbucket https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@bitbucket.org/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO}.git || true
          SOURCE_BRANCH="${{ steps.vars.outputs.SOURCE_BRANCH }}"
          git checkout $SOURCE_BRANCH
          git push bitbucket $SOURCE_BRANCH --force --verbose

      - name: Create Bitbucket PR
        env:
          BITBUCKET_USERNAME: ${{ secrets.BITBUCKET_USERNAME }}
          BITBUCKET_APP_PASSWORD: ${{ secrets.BITBUCKET_APP_PASSWORD }}
          BITBUCKET_WORKSPACE: ${{ secrets.BITBUCKET_WORKSPACE }}
          BITBUCKET_REPO: ${{ secrets.BITBUCKET_REPO }}
        run: |
          SOURCE_BRANCH="${{ steps.vars.outputs.SOURCE_BRANCH }}"
          curl -v -X POST \
            -u "${BITBUCKET_USERNAME}:${BITBUCKET_APP_PASSWORD}" \
            -H "Content-Type: application/json" \
            "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO}/pullrequests/" \
            -d '{
              "title": "Sync merged GitHub PR #${{ github.event.pull_request.number }} (${SOURCE_BRANCH})",
              "description": "Automated sync from GitHub PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.html_url }}",
              "source": {
                "branch": {
                  "name": "'${SOURCE_BRANCH}'"
                }
              },
              "destination": {
                "branch": {
                  "name": "main"
                }
              },
              "close_source_branch": false
            }'
